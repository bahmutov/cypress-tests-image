name: CI
on: push

jobs:
  # computes the hash of package.json and and stores it in the output
  # also checks if the Docker image with this tag already exists
  # outputs:
  #   hash: the package.json hash
  #   tag: whether the Docker image with this tag already exists, "found" or "not found"
  package-hash:
    runs-on: ubuntu-latest
    outputs:
      hash: ${{ steps.hash.outputs.checksum }}
      tag: ${{ steps.tag-exists.outputs.tag }}
    steps:
      - name: Checkout üõéÔ∏è
        # https://github.com/actions/checkout
        # only needed to get package.json and Dockerfile to compute the hash
        uses: actions/checkout@v6
        with:
          sparse-checkout: |
            package.json
            Dockerfile

      - name: Package.json + Dockerfile checksum
        id: hash
        run: echo "checksum=${{ hashFiles('package.json', 'Dockerfile') }}" >> $GITHUB_OUTPUT

      # https://github.com/tyriis/docker-image-tag-exists
      - name: Check if Docker image tag exists
        id: tag-exists
        uses: tyriis/docker-image-tag-exists@v2.1.0
        with:
          registry: docker.io
          repository: bahmutov/cy
          # The container image tag
          tag: ${{ steps.hash.outputs.checksum }}

  build-docker-image:
    # builds the Docker image and pushes it to the Docker hub
    # but only if it does not exist yet
    runs-on: ubuntu-latest
    needs: package-hash
    if: ${{ needs.package-hash.outputs.tag == 'not found' }}
    steps:
      - name: Checkout üõéÔ∏è
        # https://github.com/actions/checkout
        uses: actions/checkout@v6

      - name: Log in to Docker Hub
        # https://github.com/docker/login-action
        uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # we could also use the action
      # https://github.com/docker/build-push-action

      - name: Build docker image
        run: docker build -t bahmutov/cy:${{ needs.package-hash.outputs.hash }} .

      - name: Push Docker images
        run: docker push bahmutov/cy:${{ needs.package-hash.outputs.hash }}

  wait-for-build:
    # a trick to allow other jobs to run, even if the "build" job is skipped
    # runs in parallel with the "build" job and keeps checking if it is finished
    # or is skipped
    runs-on: ubuntu-latest
    needs: package-hash
    steps:
      - name: Wait for the Docker image build / skip
        # https://github.com/lewagon/wait-on-check-action
        uses: lewagon/wait-on-check-action@v1.4.1
        with:
          ref: ${{ github.ref }}
          check-name: build-docker-image
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          # seconds between checks
          wait-interval: 10

  test:
    # this job finishes after the Docker image is built (or exists already)
    runs-on: ubuntu-latest
    needs: [package-hash, wait-for-build]
    container: bahmutov/cy:${{ needs.package-hash.outputs.hash }}
    steps:
      - name: Checkout üõéÔ∏è
        # https://github.com/actions/checkout
        uses: actions/checkout@v6

      # the important step: symlink the node modules
      # from the Docker image into the working folder
      # so we can skip the installation step
      - name: Symlink node modules
        run: ln -s /e2e/node_modules ./node_modules

      - name: Print Cypress version
        run: npx cypress --version

      - name: Run Cypress tests
        run: npx cypress run

  test-action:
    # this job finishes after the Docker image is built (or exists already)
    # and verifies the Cypress GitHub action works too
    runs-on: ubuntu-latest
    needs: [package-hash, wait-for-build]
    container: bahmutov/cy:${{ needs.package-hash.outputs.hash }}
    steps:
      - name: Checkout üõéÔ∏è
        # https://github.com/actions/checkout
        uses: actions/checkout@v6

      # the important step: symlink the node modules
      # from the Docker image into the working folder
      # so we can skip the installation step
      - name: Symlink node modules
        run: ln -s /e2e/node_modules ./node_modules

      # confirm the Cypress action works too
      - name: Cypress action
        # https://github.com/cypress-io/github-action
        uses: cypress-io/github-action@v6
        with:
          install: false
