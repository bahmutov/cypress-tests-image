name: Build Docker Image
# only run when triggered manually
on:
  workflow_dispatch:

jobs:
  package-hash:
    runs-on: ubuntu-latest
    outputs:
      hash: ${{ steps.hash.outputs.checksum }}
      tag: ${{ steps.tag-exists.outputs.tag }}
    steps:
      - name: Checkout üõéÔ∏è
        # https://github.com/actions/checkout
        # only needed to get package.json file
        uses: actions/checkout@v6
        with:
          sparse-checkout: 'package.json'

      - name: Package.json checksum
        id: hash
        run: echo "checksum=${{ hashFiles('package.json') }}" >> $GITHUB_OUTPUT

      # https://github.com/tyriis/docker-image-tag-exists
      - name: Check if Docker image tag exists
        id: tag-exists
        uses: tyriis/docker-image-tag-exists@v2.1.0
        with:
          registry: docker.io
          repository: bahmutov/cy
          # The container image tag
          tag: ${{ steps.hash.outputs.checksum }}

  build-docker-image:
    runs-on: ubuntu-latest
    needs: package-hash
    if: ${{ needs.package-hash.outputs.tag == 'not found' }}
    steps:
      - name: Checkout üõéÔ∏è
        # https://github.com/actions/checkout
        uses: actions/checkout@v6

      - name: Log in to Docker Hub
        # https://github.com/docker/login-action
        uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # we could also use the action
      # https://github.com/docker/build-push-action

      - name: Build docker image
        run: docker build -t bahmutov/cy:${{ needs.package-hash.outputs.hash }} .

      - name: Push Docker images
        run: docker push bahmutov/cy:${{ needs.package-hash.outputs.hash }}
