# this workflow uses Docker images via Google Artifacts Registry (GCR)
# the registry is private, so we will use a Service Account to log in
name: CI Using Google Artifacts Registry
on: push

env:
  # gcr.io / Artifacts Registry
  REGISTRY: us-east4-docker.pkg.dev
  GCP_PROJECT: helloworld-330918
  # Artifacts Registry repository name
  REPOSITORY: gleb-google-artifact-registry-test
  IMAGE_NAME: cypress-tests-image

jobs:
  # computes the hash of package.json and and stores it in the output
  # also checks if the Docker image with this tag already exists
  # outputs:
  #   hash: the package.json hash
  #   tag: whether the Docker image with this tag already exists, "found" or "not found"
  package-hash:
    runs-on: ubuntu-latest
    outputs:
      hash: ${{ steps.hash.outputs.checksum }}
      tag: ${{ steps.tag-exists.outputs.tag }}
    steps:
      - name: Checkout üõéÔ∏è
        # https://github.com/actions/checkout
        # only needed to get package.json and Dockerfile to compute the hash
        uses: actions/checkout@v6
        with:
          sparse-checkout: |
            package.json
            Dockerfile

      - name: Package.json + Dockerfile checksum
        id: hash
        run: echo "checksum=${{ hashFiles('package.json', 'Dockerfile') }}" >> $GITHUB_OUTPUT

      - name: Log in to Google Artifacts Registry
        # https://github.com/docker/login-action
        uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
        with:
          registry: ${{ env.REGISTRY }}
          username: _json_key
          password: ${{ secrets.GCR_KEY }}

      # https://github.com/tyriis/docker-image-tag-exists
      - name: Check if Docker image tag exists
        id: tag-exists
        uses: tyriis/docker-image-tag-exists@v2.1.0
        with:
          registry: ${{ env.REGISTRY }}
          repository: ${{ env.GCP_PROJECT }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}
          # The container image tag
          tag: ${{ steps.hash.outputs.checksum }}

      - name: Report the check results
        # print the tag result into Github Actions summary
        run: |
          echo "## Docker image check" >> $GITHUB_STEP_SUMMARY
          echo "Registry: ${{ env.REGISTRY }}" >> $GITHUB_STEP_SUMMARY
          echo "Image: ${{ env.REGISTRY }}/${{ env.GCP_PROJECT }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "Package.json + Dockerfile hash: ${{ steps.hash.outputs.checksum }}" >> $GITHUB_STEP_SUMMARY
          echo "Docker image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.hash.outputs.checksum }} **${{ steps.tag-exists.outputs.tag }}**" >> $GITHUB_STEP_SUMMARY

  build-docker-image:
    # builds the Docker image and pushes it to the registry
    # but only if it does not exist yet
    runs-on: ubuntu-latest
    needs: package-hash
    permissions:
      # don't forget to allow workflows to write to GHCR
      # https://github.com/<org>/<repo>/settings/actions
      packages: write
    if: ${{ needs.package-hash.outputs.tag == 'not found' }}
    steps:
      - name: Checkout üõéÔ∏è
        # https://github.com/actions/checkout
        uses: actions/checkout@v6

      - name: Log in to Google Artifacts Registry
        # https://github.com/docker/login-action
        uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
        with:
          registry: ${{ env.REGISTRY }}
          username: _json_key
          password: ${{ secrets.GCR_KEY }}

      # we could also use the action
      # https://github.com/docker/build-push-action

      - name: Build docker image
        run: docker build -t ${{ env.REGISTRY }}/${{ env.GCP_PROJECT }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ needs.package-hash.outputs.hash }} .

      - name: Push Docker image to the correct registry
        run: docker push ${{ env.REGISTRY }}/${{ env.GCP_PROJECT }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ needs.package-hash.outputs.hash }}

  wait-for-build:
    # a trick to allow other jobs to run, even if the "build" job is skipped
    # runs in parallel with the "build" job and keeps checking if it is finished
    # or is skipped
    runs-on: ubuntu-latest
    needs: package-hash
    steps:
      - name: Wait for the Docker image build / skip
        # https://github.com/lewagon/wait-on-check-action
        uses: lewagon/wait-on-check-action@v1.4.1
        with:
          ref: ${{ github.ref }}
          check-name: build-docker-image
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          # seconds between checks
          wait-interval: 10

  test:
    # this job finishes after the Docker image is built (or exists already)
    runs-on: ubuntu-latest
    needs: [package-hash, wait-for-build]
    # seems we cannot use the env variables here
    container: us-east4-docker.pkg.dev/helloworld-330918/gleb-google-artifact-registry-test/cypress-tests-image:${{ needs.package-hash.outputs.hash }}
    steps:
      - name: Checkout üõéÔ∏è
        # https://github.com/actions/checkout
        uses: actions/checkout@v6

      # THE IMPORTANT STEP: symlink the node modules
      # from the Docker image into the working folder
      # so we can skip the installation step
      - name: Symlink node modules
        run: ln -s /e2e/node_modules ./node_modules

      - name: Print Cypress version
        run: npx cypress --version

      - name: Run Cypress tests
        run: npx cypress run
